<!DOCTYPE html>
<html lang="en-us">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='基础知识'><title>连接池</title>

<link rel='canonical' href='https://gao377020481.github.io/p/%E8%BF%9E%E6%8E%A5%E6%B1%A0/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='连接池'>
<meta property='og:description' content='基础知识'>
<meta property='og:url' content='https://gao377020481.github.io/p/%E8%BF%9E%E6%8E%A5%E6%B1%A0/'>
<meta property='og:site_name' content='Gao&#39;s Happy Day'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='池式结构' /><meta property='article:published_time' content='2020-03-21T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2020-03-21T00:00:00&#43;00:00'/><meta property='og:image' content='https://gao377020481.github.io/p/%E8%BF%9E%E6%8E%A5%E6%B1%A0/245.jpg' />
<meta name="twitter:title" content="连接池">
<meta name="twitter:description" content="基础知识"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://gao377020481.github.io/p/%E8%BF%9E%E6%8E%A5%E6%B1%A0/245.jpg' />
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="https://gao377020481.github.io" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>Back</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%E8%BF%9E%E6%8E%A5%E6%B1%A0/">
                <img src="/p/%E8%BF%9E%E6%8E%A5%E6%B1%A0/245_hubfe96db144675e6281ae6d025e60e504_7615599_800x0_resize_q75_box.jpg"
                        srcset="/p/%E8%BF%9E%E6%8E%A5%E6%B1%A0/245_hubfe96db144675e6281ae6d025e60e504_7615599_800x0_resize_q75_box.jpg 800w, /p/%E8%BF%9E%E6%8E%A5%E6%B1%A0/245_hubfe96db144675e6281ae6d025e60e504_7615599_1600x0_resize_q75_box.jpg 1600w"
                        width="800" 
                        height="600" 
                        loading="lazy"
                        alt="Featured image of post 连接池" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" style="background-color: #2a9d8f; color: #fff;">
                网络编程
            </a>
        
    </header>
    

    <h2 class="article-title">
        <a href="/p/%E8%BF%9E%E6%8E%A5%E6%B1%A0/">连接池</a>
    </h2>

    
    <h3 class="article-subtitle">
        基础知识
    </h3>
    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Mar 21, 2020</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    17 minute read
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <h1 id="连接池实现">连接池实现</h1>
<h2 id="mysql连接池">mysql连接池</h2>
<h3 id="头文件">头文件：</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#ifndef DBPOOL_H_
</span><span class="cp">#define DBPOOL_H_
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;list&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;mutex&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;condition_variable&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mysql.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define MAX_ESCAPE_STRING_LEN	10240
</span><span class="cp"></span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="c1">// 返回结果 select的时候用
</span><span class="c1"></span><span class="k">class</span> <span class="nc">CResultSet</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
	<span class="n">CResultSet</span><span class="p">(</span><span class="n">MYSQL_RES</span><span class="o">*</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">virtual</span> <span class="o">~</span><span class="n">CResultSet</span><span class="p">();</span>

	<span class="kt">bool</span> <span class="nf">Next</span><span class="p">();</span>
	<span class="kt">int</span> <span class="nf">GetInt</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="p">);</span>
	<span class="kt">char</span><span class="o">*</span> <span class="nf">GetString</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="p">);</span>
<span class="k">private</span><span class="o">:</span>
	<span class="kt">int</span> <span class="n">_GetIndex</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="p">);</span>

	<span class="n">MYSQL_RES</span><span class="o">*</span> 			<span class="n">m_res</span><span class="p">;</span>
	<span class="n">MYSQL_ROW</span>			<span class="n">m_row</span><span class="p">;</span>
	<span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span>	<span class="n">m_key_map</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// 插入数据用
</span><span class="c1"></span><span class="k">class</span> <span class="nc">CPrepareStatement</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
	<span class="n">CPrepareStatement</span><span class="p">();</span>
	<span class="k">virtual</span> <span class="o">~</span><span class="n">CPrepareStatement</span><span class="p">();</span>

	<span class="kt">bool</span> <span class="nf">Init</span><span class="p">(</span><span class="n">MYSQL</span><span class="o">*</span> <span class="n">mysql</span><span class="p">,</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">sql</span><span class="p">);</span>

	<span class="kt">void</span> <span class="nf">SetParam</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
	<span class="kt">void</span> <span class="nf">SetParam</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">index</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">SetParam</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">index</span><span class="p">,</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">SetParam</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>

	<span class="kt">bool</span> <span class="nf">ExecuteUpdate</span><span class="p">();</span>
	<span class="kt">uint32_t</span> <span class="nf">GetInsertId</span><span class="p">();</span>
<span class="k">private</span><span class="o">:</span>
	<span class="n">MYSQL_STMT</span><span class="o">*</span>	<span class="n">m_stmt</span><span class="p">;</span>
	<span class="n">MYSQL_BIND</span><span class="o">*</span>	<span class="n">m_param_bind</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">m_param_cnt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">CDBPool</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CDBConn</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
	<span class="n">CDBConn</span><span class="p">(</span><span class="n">CDBPool</span><span class="o">*</span> <span class="n">pDBPool</span><span class="p">);</span>
	<span class="k">virtual</span> <span class="o">~</span><span class="n">CDBConn</span><span class="p">();</span>
	<span class="kt">int</span> <span class="nf">Init</span><span class="p">();</span>

	<span class="c1">// 创建表
</span><span class="c1"></span>	<span class="kt">bool</span> <span class="nf">ExecuteCreate</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">sql_query</span><span class="p">);</span>
	<span class="c1">// 删除表
</span><span class="c1"></span>	<span class="kt">bool</span> <span class="nf">ExecuteDrop</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">sql_query</span><span class="p">);</span>
	<span class="c1">// 查询
</span><span class="c1"></span>	<span class="n">CResultSet</span><span class="o">*</span> <span class="nf">ExecuteQuery</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">sql_query</span><span class="p">);</span>

    <span class="cm">/**
</span><span class="cm">    *  执行DB更新，修改
</span><span class="cm">    *
</span><span class="cm">    *  @param sql_query     sql
</span><span class="cm">    *  @param care_affected_rows  是否在意影响的行数，false:不在意；true:在意
</span><span class="cm">    *
</span><span class="cm">    *  @return 成功返回true 失败返回false
</span><span class="cm">    */</span>
	<span class="kt">bool</span> <span class="nf">ExecuteUpdate</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">sql_query</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">care_affected_rows</span> <span class="o">=</span> <span class="nb">true</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="nf">GetInsertId</span><span class="p">();</span>

	<span class="c1">// 开启事务
</span><span class="c1"></span>	<span class="kt">bool</span> <span class="nf">StartTransaction</span><span class="p">();</span>
	<span class="c1">// 提交事务
</span><span class="c1"></span>	<span class="kt">bool</span> <span class="nf">Commit</span><span class="p">();</span>
	<span class="c1">// 回滚事务
</span><span class="c1"></span>	<span class="kt">bool</span> <span class="nf">Rollback</span><span class="p">();</span>
	<span class="c1">// 获取连接池名
</span><span class="c1"></span>	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">GetPoolName</span><span class="p">();</span>
	<span class="n">MYSQL</span><span class="o">*</span> <span class="nf">GetMysql</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_mysql</span><span class="p">;</span> <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
	<span class="n">CDBPool</span><span class="o">*</span> 	<span class="n">m_pDBPool</span><span class="p">;</span>	<span class="c1">// to get MySQL server information
</span><span class="c1"></span>	<span class="n">MYSQL</span><span class="o">*</span> 		<span class="n">m_mysql</span><span class="p">;</span>	<span class="c1">// 对应一个连接
</span><span class="c1"></span>	<span class="kt">char</span>		<span class="n">m_escape_string</span><span class="p">[</span><span class="n">MAX_ESCAPE_STRING_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">CDBPool</span> <span class="p">{</span>	<span class="c1">// 只是负责管理连接CDBConn，真正干活的是CDBConn
</span><span class="c1"></span><span class="k">public</span><span class="o">:</span>
	<span class="n">CDBPool</span><span class="p">()</span> <span class="p">{}</span>
	<span class="n">CDBPool</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pool_name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">db_server_ip</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">db_server_port</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">username</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">password</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">db_name</span><span class="p">,</span> 
			<span class="kt">int</span> <span class="n">max_conn_cnt</span><span class="p">);</span>
	<span class="k">virtual</span> 	<span class="o">~</span><span class="n">CDBPool</span><span class="p">();</span>

	<span class="kt">int</span> 		<span class="nf">Init</span><span class="p">();</span>		<span class="c1">// 连接数据库，创建连接
</span><span class="c1"></span>	<span class="n">CDBConn</span><span class="o">*</span> 	<span class="nf">GetDBConn</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">timeout_ms</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>	<span class="c1">// 获取连接资源
</span><span class="c1"></span>	<span class="kt">void</span> 		<span class="nf">RelDBConn</span><span class="p">(</span><span class="n">CDBConn</span><span class="o">*</span> <span class="n">pConn</span><span class="p">);</span>	<span class="c1">// 归还连接资源
</span><span class="c1"></span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">GetPoolName</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_pool_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span> <span class="p">}</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">GetDBServerIP</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_db_server_ip</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span> <span class="p">}</span>
	<span class="kt">uint16_t</span> 	<span class="nf">GetDBServerPort</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_db_server_port</span><span class="p">;</span> <span class="p">}</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">GetUsername</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_username</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span> <span class="p">}</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">GetPasswrod</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_password</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span> <span class="p">}</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">GetDBName</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_db_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span> <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
	<span class="n">string</span> 		<span class="n">m_pool_name</span><span class="p">;</span>	<span class="c1">// 连接池名称
</span><span class="c1"></span>	<span class="n">string</span> 		<span class="n">m_db_server_ip</span><span class="p">;</span>	<span class="c1">// 数据库ip
</span><span class="c1"></span>	<span class="kt">uint16_t</span>	<span class="n">m_db_server_port</span><span class="p">;</span> <span class="c1">// 数据库端口
</span><span class="c1"></span>	<span class="n">string</span> 		<span class="n">m_username</span><span class="p">;</span>  	<span class="c1">// 用户名
</span><span class="c1"></span>	<span class="n">string</span> 		<span class="n">m_password</span><span class="p">;</span>		<span class="c1">// 用户密码
</span><span class="c1"></span>	<span class="n">string</span> 		<span class="n">m_db_name</span><span class="p">;</span>		<span class="c1">// db名称
</span><span class="c1"></span>	<span class="kt">int</span>			<span class="n">m_db_cur_conn_cnt</span><span class="p">;</span>	<span class="c1">// 当前启用的连接数量
</span><span class="c1"></span>	<span class="kt">int</span> 		<span class="n">m_db_max_conn_cnt</span><span class="p">;</span>	<span class="c1">// 最大连接数量
</span><span class="c1"></span>	<span class="n">list</span><span class="o">&lt;</span><span class="n">CDBConn</span><span class="o">*&gt;</span>	<span class="n">m_free_list</span><span class="p">;</span>	<span class="c1">// 空闲的连接
</span><span class="c1"></span>
	<span class="n">list</span><span class="o">&lt;</span><span class="n">CDBConn</span><span class="o">*&gt;</span>	<span class="n">m_used_list</span><span class="p">;</span>		<span class="c1">// 记录已经被请求的连接
</span><span class="c1"></span>	<span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">m_mutex</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span> <span class="n">m_cond_var</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">m_abort_request</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="c1">// CThreadNotify	m_free_notify;	// 信号量
</span><span class="c1"></span><span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* DBPOOL_H_ */</span><span class="cp">
</span><span class="cp"></span>
<span class="p">};</span>
</code></pre></div><h3 id="实现">实现：</h3>
<hr>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&#34;DBPool.h&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define log_error printf
</span><span class="cp">#define log_warn printf
</span><span class="cp">#define log_info printf
</span><span class="cp">#define MIN_DB_CONN_CNT 2
</span><span class="cp">#define MAX_DB_CONN_FAIL_NUM 10
</span><span class="cp"></span>

<span class="n">CResultSet</span><span class="o">::</span><span class="n">CResultSet</span><span class="p">(</span><span class="n">MYSQL_RES</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m_res</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>

	<span class="c1">// map table field key to index in the result array
</span><span class="c1"></span>	<span class="kt">int</span> <span class="n">num_fields</span> <span class="o">=</span> <span class="n">mysql_num_fields</span><span class="p">(</span><span class="n">m_res</span><span class="p">);</span>
	<span class="n">MYSQL_FIELD</span> <span class="o">*</span><span class="n">fields</span> <span class="o">=</span> <span class="n">mysql_fetch_fields</span><span class="p">(</span><span class="n">m_res</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_fields</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">// 多行
</span><span class="c1"></span>		<span class="n">m_key_map</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">make_pair</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">CResultSet</span><span class="o">::~</span><span class="n">CResultSet</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m_res</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">mysql_free_result</span><span class="p">(</span><span class="n">m_res</span><span class="p">);</span>
		<span class="n">m_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CResultSet</span><span class="o">::</span><span class="n">Next</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">m_row</span> <span class="o">=</span> <span class="n">mysql_fetch_row</span><span class="p">(</span><span class="n">m_res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m_row</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">CResultSet</span><span class="o">::</span><span class="n">_GetIndex</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">m_key_map</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">==</span> <span class="n">m_key_map</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">CResultSet</span><span class="o">::</span><span class="n">GetInt</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">_GetIndex</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nf">atoi</span><span class="p">(</span><span class="n">m_row</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span> <span class="c1">// 有索引
</span><span class="c1"></span>	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="o">*</span><span class="n">CResultSet</span><span class="o">::</span><span class="n">GetString</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">_GetIndex</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">m_row</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>		<span class="c1">// 列
</span><span class="c1"></span>	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">/////////////////////////////////////////
</span><span class="c1"></span><span class="n">CPrepareStatement</span><span class="o">::</span><span class="n">CPrepareStatement</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">m_stmt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">m_param_bind</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">m_param_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">CPrepareStatement</span><span class="o">::~</span><span class="n">CPrepareStatement</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m_stmt</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">mysql_stmt_close</span><span class="p">(</span><span class="n">m_stmt</span><span class="p">);</span>
		<span class="n">m_stmt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m_param_bind</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">delete</span><span class="p">[]</span> <span class="n">m_param_bind</span><span class="p">;</span>
		<span class="n">m_param_bind</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CPrepareStatement</span><span class="o">::</span><span class="n">Init</span><span class="p">(</span><span class="n">MYSQL</span> <span class="o">*</span><span class="n">mysql</span><span class="p">,</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">sql</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mysql_ping</span><span class="p">(</span><span class="n">mysql</span><span class="p">);</span>	<span class="c1">// 当mysql连接丢失的时候，使用mysql_ping能够自动重连数据库
</span><span class="c1"></span>
	<span class="c1">//g_master_conn_fail_num ++;
</span><span class="c1"></span>	<span class="n">m_stmt</span> <span class="o">=</span> <span class="n">mysql_stmt_init</span><span class="p">(</span><span class="n">mysql</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_stmt</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_stmt_init failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mysql_stmt_prepare</span><span class="p">(</span><span class="n">m_stmt</span><span class="p">,</span> <span class="n">sql</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">sql</span><span class="p">.</span><span class="n">size</span><span class="p">()))</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_stmt_prepare failed: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mysql_stmt_error</span><span class="p">(</span><span class="n">m_stmt</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m_param_cnt</span> <span class="o">=</span> <span class="n">mysql_stmt_param_count</span><span class="p">(</span><span class="n">m_stmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m_param_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">m_param_bind</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MYSQL_BIND</span><span class="p">[</span><span class="n">m_param_cnt</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_param_bind</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;new failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">m_param_bind</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MYSQL_BIND</span><span class="p">)</span> <span class="o">*</span> <span class="n">m_param_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">CPrepareStatement</span><span class="o">::</span><span class="n">SetParam</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">m_param_cnt</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;index too large: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m_param_bind</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">buffer_type</span> <span class="o">=</span> <span class="n">MYSQL_TYPE_LONG</span><span class="p">;</span>
	<span class="n">m_param_bind</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">CPrepareStatement</span><span class="o">::</span><span class="n">SetParam</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">index</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">m_param_cnt</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;index too large: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m_param_bind</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">buffer_type</span> <span class="o">=</span> <span class="n">MYSQL_TYPE_LONG</span><span class="p">;</span>
	<span class="n">m_param_bind</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">CPrepareStatement</span><span class="o">::</span><span class="n">SetParam</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">index</span><span class="p">,</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">m_param_cnt</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;index too large: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m_param_bind</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">buffer_type</span> <span class="o">=</span> <span class="n">MYSQL_TYPE_STRING</span><span class="p">;</span>
	<span class="n">m_param_bind</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">value</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
	<span class="n">m_param_bind</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">buffer_length</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">CPrepareStatement</span><span class="o">::</span><span class="n">SetParam</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">m_param_cnt</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;index too large: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m_param_bind</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">buffer_type</span> <span class="o">=</span> <span class="n">MYSQL_TYPE_STRING</span><span class="p">;</span>
	<span class="n">m_param_bind</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">value</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
	<span class="n">m_param_bind</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">buffer_length</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CPrepareStatement</span><span class="o">::</span><span class="n">ExecuteUpdate</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_stmt</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;no m_stmt</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mysql_stmt_bind_param</span><span class="p">(</span><span class="n">m_stmt</span><span class="p">,</span> <span class="n">m_param_bind</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_stmt_bind_param failed: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mysql_stmt_error</span><span class="p">(</span><span class="n">m_stmt</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mysql_stmt_execute</span><span class="p">(</span><span class="n">m_stmt</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_stmt_execute failed: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mysql_stmt_error</span><span class="p">(</span><span class="n">m_stmt</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mysql_stmt_affected_rows</span><span class="p">(</span><span class="n">m_stmt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;ExecuteUpdate have no effect</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint32_t</span> <span class="n">CPrepareStatement</span><span class="o">::</span><span class="n">GetInsertId</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nf">mysql_stmt_insert_id</span><span class="p">(</span><span class="n">m_stmt</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">/////////////////////
</span><span class="c1"></span><span class="n">CDBConn</span><span class="o">::</span><span class="n">CDBConn</span><span class="p">(</span><span class="n">CDBPool</span> <span class="o">*</span><span class="n">pPool</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m_pDBPool</span> <span class="o">=</span> <span class="n">pPool</span><span class="p">;</span>
	<span class="n">m_mysql</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">CDBConn</span><span class="o">::~</span><span class="n">CDBConn</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m_mysql</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">mysql_close</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">CDBConn</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">m_mysql</span> <span class="o">=</span> <span class="n">mysql_init</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>	<span class="c1">// mysql_标准的mysql c client对应的api
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_mysql</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_init failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">my_bool</span> <span class="n">reconnect</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">mysql_options</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">,</span> <span class="n">MYSQL_OPT_RECONNECT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reconnect</span><span class="p">);</span>	<span class="c1">// 配合mysql_ping实现自动重连
</span><span class="c1"></span>	<span class="n">mysql_options</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">,</span> <span class="n">MYSQL_SET_CHARSET_NAME</span><span class="p">,</span> <span class="s">&#34;utf8mb4&#34;</span><span class="p">);</span>	<span class="c1">// utf8mb4和utf8区别
</span><span class="c1"></span>
	<span class="c1">// ip 端口 用户名 密码 数据库名
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mysql_real_connect</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">,</span> <span class="n">m_pDBPool</span><span class="o">-&gt;</span><span class="n">GetDBServerIP</span><span class="p">(),</span> <span class="n">m_pDBPool</span><span class="o">-&gt;</span><span class="n">GetUsername</span><span class="p">(),</span> <span class="n">m_pDBPool</span><span class="o">-&gt;</span><span class="n">GetPasswrod</span><span class="p">(),</span>
							<span class="n">m_pDBPool</span><span class="o">-&gt;</span><span class="n">GetDBName</span><span class="p">(),</span> <span class="n">m_pDBPool</span><span class="o">-&gt;</span><span class="n">GetDBServerPort</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_real_connect failed: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mysql_error</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">CDBConn</span><span class="o">::</span><span class="n">GetPoolName</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">m_pDBPool</span><span class="o">-&gt;</span><span class="n">GetPoolName</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CDBConn</span><span class="o">::</span><span class="n">ExecuteCreate</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sql_query</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mysql_ping</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">);</span>
	<span class="c1">// mysql_real_query 实际就是执行了SQL
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">mysql_real_query</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">,</span> <span class="n">sql_query</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sql_query</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_real_query failed: %s, sql: start transaction</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mysql_error</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">bool</span> <span class="n">CDBConn</span><span class="o">::</span><span class="n">ExecuteDrop</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sql_query</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mysql_ping</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">);</span>	<span class="c1">// 如果端开了，能够自动重连
</span><span class="c1"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mysql_real_query</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">,</span> <span class="n">sql_query</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sql_query</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_real_query failed: %s, sql: start transaction</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mysql_error</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">CResultSet</span> <span class="o">*</span><span class="n">CDBConn</span><span class="o">::</span><span class="n">ExecuteQuery</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sql_query</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mysql_ping</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mysql_real_query</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">,</span> <span class="n">sql_query</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sql_query</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_real_query failed: %s, sql: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mysql_error</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">),</span> <span class="n">sql_query</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="c1">// 返回结果
</span><span class="c1"></span>	<span class="n">MYSQL_RES</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">mysql_store_result</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">);</span>	<span class="c1">// 返回结果
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_store_result failed: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mysql_error</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CResultSet</span> <span class="o">*</span><span class="n">result_set</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CResultSet</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>	<span class="c1">// 存储到CResultSet
</span><span class="c1"></span>	<span class="k">return</span> <span class="n">result_set</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*
</span><span class="cm">1.执行成功，则返回受影响的行的数目，如果最近一次查询失败的话，函数返回 -1
</span><span class="cm">
</span><span class="cm">2.对于delete,将返回实际删除的行数.
</span><span class="cm">
</span><span class="cm">3.对于update,如果更新的列值原值和新值一样,如update tables set col1=10 where id=1;
</span><span class="cm">id=1该条记录原值就是10的话,则返回0。
</span><span class="cm">
</span><span class="cm">mysql_affected_rows返回的是实际更新的行数,而不是匹配到的行数。
</span><span class="cm">*/</span>
<span class="kt">bool</span> <span class="n">CDBConn</span><span class="o">::</span><span class="n">ExecuteUpdate</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sql_query</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">care_affected_rows</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mysql_ping</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mysql_real_query</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">,</span> <span class="n">sql_query</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sql_query</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_real_query failed: %s, sql: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mysql_error</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">),</span> <span class="n">sql_query</span><span class="p">);</span>
		<span class="c1">//g_master_conn_fail_num ++;
</span><span class="c1"></span>		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mysql_affected_rows</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span> <span class="c1">// 影响的行数为0时
</span><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">care_affected_rows</span><span class="p">)</span>
		<span class="p">{</span> <span class="c1">// 如果在意影响的行数时, 返回false, 否则返回true
</span><span class="c1"></span>			<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_real_query failed: %s, sql: %s</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mysql_error</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">),</span> <span class="n">sql_query</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">log_warn</span><span class="p">(</span><span class="s">&#34;affected_rows=0, sql: %s</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sql_query</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CDBConn</span><span class="o">::</span><span class="n">StartTransaction</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">mysql_ping</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mysql_real_query</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">,</span> <span class="s">&#34;start transaction</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_real_query failed: %s, sql: start transaction</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mysql_error</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CDBConn</span><span class="o">::</span><span class="n">Rollback</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">mysql_ping</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mysql_real_query</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">,</span> <span class="s">&#34;rollback</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_real_query failed: %s, sql: rollback</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mysql_error</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CDBConn</span><span class="o">::</span><span class="n">Commit</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">mysql_ping</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mysql_real_query</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">,</span> <span class="s">&#34;commit</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;mysql_real_query failed: %s, sql: commit</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mysql_error</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">uint32_t</span> <span class="n">CDBConn</span><span class="o">::</span><span class="n">GetInsertId</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">mysql_insert_id</span><span class="p">(</span><span class="n">m_mysql</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">////////////////
</span><span class="c1"></span><span class="n">CDBPool</span><span class="o">::</span><span class="n">CDBPool</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pool_name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">db_server_ip</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">db_server_port</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">username</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">db_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_conn_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m_pool_name</span> <span class="o">=</span> <span class="n">pool_name</span><span class="p">;</span>
	<span class="n">m_db_server_ip</span> <span class="o">=</span> <span class="n">db_server_ip</span><span class="p">;</span>
	<span class="n">m_db_server_port</span> <span class="o">=</span> <span class="n">db_server_port</span><span class="p">;</span>
	<span class="n">m_username</span> <span class="o">=</span> <span class="n">username</span><span class="p">;</span>
	<span class="n">m_password</span> <span class="o">=</span> <span class="n">password</span><span class="p">;</span>
	<span class="n">m_db_name</span> <span class="o">=</span> <span class="n">db_name</span><span class="p">;</span>
	<span class="n">m_db_max_conn_cnt</span> <span class="o">=</span> <span class="n">max_conn_cnt</span><span class="p">;</span>	<span class="c1">// 
</span><span class="c1"></span>	<span class="n">m_db_cur_conn_cnt</span> <span class="o">=</span> <span class="n">MIN_DB_CONN_CNT</span><span class="p">;</span> <span class="c1">// 最小连接数量
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// 释放连接池
</span><span class="c1"></span><span class="n">CDBPool</span><span class="o">::~</span><span class="n">CDBPool</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">m_mutex</span><span class="p">);</span>
	<span class="n">m_abort_request</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">m_cond_var</span><span class="p">.</span><span class="n">notify_all</span><span class="p">();</span>		<span class="c1">// 通知所有在等待的
</span><span class="c1"></span>
	<span class="k">for</span> <span class="p">(</span><span class="n">list</span><span class="o">&lt;</span><span class="n">CDBConn</span> <span class="o">*&gt;::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">m_free_list</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">m_free_list</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">CDBConn</span> <span class="o">*</span><span class="n">pConn</span> <span class="o">=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
		<span class="k">delete</span> <span class="n">pConn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m_free_list</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">CDBPool</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span>
<span class="p">{</span>
	<span class="c1">// 创建固定最小的连接数量
</span><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m_db_cur_conn_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">CDBConn</span> <span class="o">*</span><span class="n">pDBConn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CDBConn</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">pDBConn</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">delete</span> <span class="n">pDBConn</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">m_free_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pDBConn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="c1">// log_error(&#34;db pool: %s, size: %d\n&#34;, m_pool_name.c_str(), (int)m_free_list.size());
</span><span class="c1"></span>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*
</span><span class="cm"> *TODO: 增加保护机制，把分配的连接加入另一个队列，这样获取连接时，如果没有空闲连接，
</span><span class="cm"> *TODO: 检查已经分配的连接多久没有返回，如果超过一定时间，则自动收回连接，放在用户忘了调用释放连接的接口
</span><span class="cm"> * timeout_ms默认为-1死等
</span><span class="cm"> * timeout_ms &gt;=0 则为等待的时间
</span><span class="cm"> */</span>
<span class="kt">int</span> <span class="n">wait_cout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">CDBConn</span> <span class="o">*</span><span class="n">CDBPool</span><span class="o">::</span><span class="n">GetDBConn</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">timeout_ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">m_mutex</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">m_abort_request</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="n">log_warn</span><span class="p">(</span><span class="s">&#34;have aboort</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m_free_list</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>		<span class="c1">// 当没有连接可以用时
</span><span class="c1"></span>	<span class="p">{</span>
		<span class="c1">// 第一步先检测 当前连接数量是否达到最大的连接数量 
</span><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">m_db_cur_conn_cnt</span> <span class="o">&gt;=</span> <span class="n">m_db_max_conn_cnt</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="c1">// 如果已经到达了，看看是否需要超时等待
</span><span class="c1"></span>			<span class="k">if</span><span class="p">(</span><span class="n">timeout_ms</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>		<span class="c1">// 死等，直到有连接可以用 或者 连接池要退出
</span><span class="c1"></span>			<span class="p">{</span>
				<span class="n">log_info</span><span class="p">(</span><span class="s">&#34;wait ms:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">);</span>
				<span class="n">m_cond_var</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="p">[</span><span class="k">this</span><span class="p">]</span> 
				<span class="p">{</span>
					<span class="c1">// log_info(&#34;wait:%d, size:%d\n&#34;, wait_cout++, m_free_list.size());
</span><span class="c1"></span>					<span class="c1">// 当前连接数量小于最大连接数量 或者请求释放连接池时退出
</span><span class="c1"></span>					<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">m_free_list</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="o">|</span> <span class="n">m_abort_request</span><span class="p">;</span>
				<span class="p">});</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="c1">// return如果返回 false，继续wait(或者超时),  如果返回true退出wait
</span><span class="c1"></span>				<span class="c1">// 1.m_free_list不为空
</span><span class="c1"></span>				<span class="c1">// 2.超时退出
</span><span class="c1"></span>				<span class="c1">// 3. m_abort_request被置为true，要释放整个连接池
</span><span class="c1"></span>				<span class="n">m_cond_var</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="n">timeout_ms</span><span class="p">),</span> <span class="p">[</span><span class="k">this</span><span class="p">]</span> <span class="p">{</span>
					<span class="c1">// log_info(&#34;wait_for:%d, size:%d\n&#34;, wait_cout++, m_free_list.size());
</span><span class="c1"></span>					<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">m_free_list</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="o">|</span> <span class="n">m_abort_request</span><span class="p">;</span>
				<span class="p">});</span>
				<span class="c1">// 带超时功能时还要判断是否为空
</span><span class="c1"></span>				<span class="k">if</span><span class="p">(</span><span class="n">m_free_list</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> 	<span class="c1">// 如果连接池还是没有空闲则退出
</span><span class="c1"></span>				<span class="p">{</span>
					<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span><span class="p">(</span><span class="n">m_abort_request</span><span class="p">)</span> 
			<span class="p">{</span>
				<span class="n">log_warn</span><span class="p">(</span><span class="s">&#34;have aboort</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="c1">// 还没有到最大连接则创建连接
</span><span class="c1"></span>		<span class="p">{</span>
			<span class="n">CDBConn</span> <span class="o">*</span><span class="n">pDBConn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CDBConn</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>	<span class="c1">//新建连接
</span><span class="c1"></span>			<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">pDBConn</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;Init DBConnecton failed</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">);</span>
				<span class="k">delete</span> <span class="n">pDBConn</span><span class="p">;</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">m_free_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pDBConn</span><span class="p">);</span>
				<span class="n">m_db_cur_conn_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="n">log_info</span><span class="p">(</span><span class="s">&#34;new db connection: %s, conn_cnt: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pool_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">m_db_cur_conn_cnt</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">CDBConn</span> <span class="o">*</span><span class="n">pConn</span> <span class="o">=</span> <span class="n">m_free_list</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>	<span class="c1">// 获取连接
</span><span class="c1"></span>	<span class="n">m_free_list</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>	<span class="c1">// STL 吐出连接，从空闲队列删除
</span><span class="c1"></span>	<span class="c1">// pConn-&gt;setCurrentTime();  // 伪代码
</span><span class="c1"></span>	<span class="n">m_used_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pConn</span><span class="p">);</span>		<span class="c1">// 
</span><span class="c1"></span>
	<span class="k">return</span> <span class="n">pConn</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">CDBPool</span><span class="o">::</span><span class="n">RelDBConn</span><span class="p">(</span><span class="n">CDBConn</span> <span class="o">*</span><span class="n">pConn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">m_mutex</span><span class="p">);</span>

	<span class="n">list</span><span class="o">&lt;</span><span class="n">CDBConn</span> <span class="o">*&gt;::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">m_free_list</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">m_free_list</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span>	<span class="c1">// 避免重复归还
</span><span class="c1"></span>	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">it</span> <span class="o">==</span> <span class="n">pConn</span><span class="p">)</span>	
		<span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">==</span> <span class="n">m_free_list</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="n">m_used_list</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pConn</span><span class="p">);</span>
		<span class="n">m_free_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pConn</span><span class="p">);</span>
		<span class="n">m_cond_var</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span>		<span class="c1">// 通知取队列
</span><span class="c1"></span>	<span class="p">}</span> <span class="k">else</span> 
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;RelDBConn failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="c1">// 遍历检测是否超时未归还
</span><span class="c1">// pConn-&gt;isTimeout(); // 当前时间 - 被请求的时间
</span><span class="c1">// 强制回收  从m_used_list 放回 m_free_list
</span></code></pre></div><h2 id="redis连接池">redis连接池</h2>
<p>=============</p>
<h3 id="头文件-1">头文件</h3>
<hr>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cm">/*
</span><span class="cm"> * @Author: your name
</span><span class="cm"> * @Date: 2019-12-07 10:54:57
</span><span class="cm"> * @LastEditTime : 2020-01-10 16:35:13
</span><span class="cm"> * @LastEditors  : Please set LastEditors
</span><span class="cm"> * @Description: In User Settings Edit
</span><span class="cm"> * @FilePath: \src\cache_pool\CachePool.h
</span><span class="cm"> */</span>
<span class="cp">#ifndef CACHEPOOL_H_
</span><span class="cp">#define CACHEPOOL_H_
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;list&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;Thread.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;hiredis.h&#34;</span><span class="cp">
</span><span class="cp"></span>

<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="p">;</span> 
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="p">;</span> 

<span class="k">class</span> <span class="nc">CachePool</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CacheConn</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
	<span class="n">CacheConn</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">server_ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">server_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">db_index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">password</span><span class="p">,</span> 
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pool_name</span> <span class="o">=</span><span class="s">&#34;&#34;</span><span class="p">);</span>
	<span class="n">CacheConn</span><span class="p">(</span><span class="n">CachePool</span><span class="o">*</span> <span class="n">pCachePool</span><span class="p">);</span>	
	<span class="k">virtual</span> <span class="o">~</span><span class="n">CacheConn</span><span class="p">();</span>
	
	<span class="kt">int</span> <span class="nf">Init</span><span class="p">();</span>
	<span class="kt">void</span> <span class="nf">DeInit</span><span class="p">();</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">GetPoolName</span><span class="p">();</span>
    <span class="c1">// 通用操作
</span><span class="c1"></span>    <span class="c1">// 判断一个key是否存在
</span><span class="c1"></span>    <span class="kt">bool</span> <span class="nf">isExists</span><span class="p">(</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
    <span class="c1">// 删除某个key
</span><span class="c1"></span>    <span class="kt">long</span> <span class="nf">del</span><span class="p">(</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>

    <span class="c1">// ------------------- 字符串相关 -------------------
</span><span class="c1"></span>	<span class="n">string</span> <span class="nf">get</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">);</span>
    <span class="n">string</span> <span class="nf">set</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">string</span> <span class="nf">setex</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">string</span> <span class="n">value</span><span class="p">);</span>
	
	<span class="c1">// string mset(string key, map);
</span><span class="c1"></span>    <span class="c1">//批量获取
</span><span class="c1"></span>    <span class="kt">bool</span> <span class="nf">mget</span><span class="p">(</span><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">keys</span><span class="p">,</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">ret_value</span><span class="p">);</span>
	<span class="c1">//原子加减1
</span><span class="c1"></span>    <span class="kt">long</span> <span class="nf">incr</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">);</span>
    <span class="kt">long</span> <span class="nf">decr</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">);</span>


	<span class="c1">// ---------------- 哈希相关 ------------------------
</span><span class="c1"></span>	<span class="kt">long</span> <span class="nf">hdel</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span> <span class="n">field</span><span class="p">);</span>
	<span class="n">string</span> <span class="nf">hget</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span> <span class="n">field</span><span class="p">);</span>
	<span class="kt">bool</span> <span class="nf">hgetAll</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">ret_value</span><span class="p">);</span>
	<span class="kt">long</span> <span class="nf">hset</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span> <span class="n">field</span><span class="p">,</span> <span class="n">string</span> <span class="n">value</span><span class="p">);</span>

	<span class="kt">long</span> <span class="nf">hincrBy</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span> <span class="n">field</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">long</span> <span class="nf">incrBy</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">string</span> <span class="nf">hmset</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">hash</span><span class="p">);</span>
	<span class="kt">bool</span> <span class="nf">hmget</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">fields</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">ret_value</span><span class="p">);</span>
    
    

	<span class="c1">// ------------ 链表相关 ------------
</span><span class="c1"></span>	<span class="kt">long</span> <span class="nf">lpush</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span> <span class="n">value</span><span class="p">);</span>
	<span class="kt">long</span> <span class="nf">rpush</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span> <span class="n">value</span><span class="p">);</span>
	<span class="kt">long</span> <span class="nf">llen</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">);</span>
	<span class="kt">bool</span> <span class="nf">lrange</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">long</span> <span class="n">end</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">ret_value</span><span class="p">);</span>

	
    <span class="kt">bool</span> <span class="nf">flushdb</span><span class="p">();</span>

<span class="k">private</span><span class="o">:</span>
	<span class="n">CachePool</span><span class="o">*</span> 		<span class="n">m_pCachePool</span><span class="p">;</span>
	<span class="n">redisContext</span><span class="o">*</span> 	<span class="n">m_pContext</span><span class="p">;</span>
	<span class="kt">uint64_t</span>		<span class="n">m_last_connect_time</span><span class="p">;</span>
	<span class="kt">uint16_t</span> 		<span class="n">m_server_port</span><span class="p">;</span>
	<span class="n">string</span> 			<span class="n">m_server_ip</span><span class="p">;</span>
    <span class="n">string</span>          <span class="n">m_password</span><span class="p">;</span>
	<span class="kt">uint16_t</span>        <span class="n">m_db_index</span><span class="p">;</span>
	<span class="n">string</span> 			<span class="n">m_pool_name</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">class</span> <span class="nc">CachePool</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
	<span class="c1">// db_index和mysql不同的地方 
</span><span class="c1"></span>	<span class="n">CachePool</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pool_name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">server_ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">server_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">db_index</span><span class="p">,</span> 
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_conn_cnt</span><span class="p">);</span>
	<span class="k">virtual</span> <span class="o">~</span><span class="n">CachePool</span><span class="p">();</span>

	<span class="kt">int</span> <span class="nf">Init</span><span class="p">();</span>
    <span class="c1">// 获取空闲的连接资源
</span><span class="c1"></span>	<span class="n">CacheConn</span><span class="o">*</span> <span class="nf">GetCacheConn</span><span class="p">();</span>
    <span class="c1">// Pool回收连接资源
</span><span class="c1"></span>	<span class="kt">void</span> <span class="nf">RelCacheConn</span><span class="p">(</span><span class="n">CacheConn</span><span class="o">*</span> <span class="n">pCacheConn</span><span class="p">);</span>

	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">GetPoolName</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_pool_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span> <span class="p">}</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">GetServerIP</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_server_ip</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span> <span class="p">}</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">GetPassword</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_password</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span> <span class="p">}</span>
	<span class="kt">int</span> <span class="nf">GetServerPort</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_server_port</span><span class="p">;</span> <span class="p">}</span>
	<span class="kt">int</span> <span class="nf">GetDBIndex</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_db_index</span><span class="p">;</span> <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
	<span class="n">string</span> 		<span class="n">m_pool_name</span><span class="p">;</span>
	<span class="n">string</span>		<span class="n">m_server_ip</span><span class="p">;</span>
	<span class="n">string</span> 		<span class="n">m_password</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">m_server_port</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">m_db_index</span><span class="p">;</span>	<span class="c1">// mysql 数据库名字， redis db index
</span><span class="c1"></span>
	<span class="kt">int</span>			<span class="n">m_cur_conn_cnt</span><span class="p">;</span>
	<span class="kt">int</span> 		<span class="n">m_max_conn_cnt</span><span class="p">;</span>
	<span class="n">list</span><span class="o">&lt;</span><span class="n">CacheConn</span><span class="o">*&gt;</span>	<span class="n">m_free_list</span><span class="p">;</span>
	<span class="n">CThreadNotify</span>		<span class="n">m_free_notify</span><span class="p">;</span>
<span class="p">};</span>



<span class="cp">#endif </span><span class="cm">/* CACHEPOOL_H_ */</span><span class="cp">
</span><span class="cp"></span>
</code></pre></div><h3 id="实现-1">实现</h3>
<hr>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&#34;CachePool.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;Thread.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define log_error printf
</span><span class="cp">#define log_info printf
</span><span class="cp"></span>
<span class="cp">#define MIN_CACHE_CONN_CNT 2
</span><span class="cp">#define MAX_CACHE_CONN_FAIL_NUM 10
</span><span class="cp"></span>
<span class="n">CacheConn</span><span class="o">::</span><span class="n">CacheConn</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">server_ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">server_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">db_index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pool_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m_server_ip</span> <span class="o">=</span> <span class="n">server_ip</span><span class="p">;</span>
	<span class="n">m_server_port</span> <span class="o">=</span> <span class="n">server_port</span><span class="p">;</span>

	<span class="n">m_db_index</span> <span class="o">=</span> <span class="n">db_index</span><span class="p">;</span>
	<span class="n">m_password</span> <span class="o">=</span> <span class="n">password</span><span class="p">;</span>
	<span class="n">m_pool_name</span> <span class="o">=</span> <span class="n">pool_name</span><span class="p">;</span>
	<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">m_last_connect_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">CacheConn</span><span class="o">::</span><span class="n">CacheConn</span><span class="p">(</span><span class="n">CachePool</span> <span class="o">*</span><span class="n">pCachePool</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m_pCachePool</span> <span class="o">=</span> <span class="n">pCachePool</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pCachePool</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">m_server_ip</span> <span class="o">=</span> <span class="n">pCachePool</span><span class="o">-&gt;</span><span class="n">GetServerIP</span><span class="p">();</span>
		<span class="n">m_server_port</span> <span class="o">=</span> <span class="n">pCachePool</span><span class="o">-&gt;</span><span class="n">GetServerPort</span><span class="p">();</span>
		<span class="n">m_db_index</span> <span class="o">=</span> <span class="n">pCachePool</span><span class="o">-&gt;</span><span class="n">GetDBIndex</span><span class="p">();</span>
		<span class="n">m_password</span> <span class="o">=</span> <span class="n">pCachePool</span><span class="o">-&gt;</span><span class="n">GetPassword</span><span class="p">();</span>
		<span class="n">m_pool_name</span> <span class="o">=</span> <span class="n">pCachePool</span><span class="o">-&gt;</span><span class="n">GetPoolName</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;pCachePool is NULL</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">m_last_connect_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">CacheConn</span><span class="o">::~</span><span class="n">CacheConn</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m_pContext</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*
</span><span class="cm"> * redis初始化连接和重连操作，类似mysql_ping()
</span><span class="cm"> */</span>
<span class="kt">int</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m_pContext</span><span class="p">)</span>	<span class="c1">// 非空，连接是正常的
</span><span class="c1"></span>	<span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">// 1s 尝试重连一次
</span><span class="c1"></span>	<span class="kt">uint64_t</span> <span class="n">cur_time</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur_time</span> <span class="o">&lt;</span> <span class="n">m_last_connect_time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> 		<span class="c1">// 重连尝试 间隔1秒 
</span><span class="c1"></span>	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;cur_time:%lu, m_last_connect_time:%lu</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">cur_time</span><span class="p">,</span> <span class="n">m_last_connect_time</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="c1">// printf(&#34;m_last_connect_time = cur_time\n&#34;);
</span><span class="c1"></span>	<span class="n">m_last_connect_time</span> <span class="o">=</span> <span class="n">cur_time</span><span class="p">;</span>

	<span class="c1">// 1000ms超时
</span><span class="c1"></span>	<span class="k">struct</span> <span class="nc">timeval</span> <span class="n">timeout</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">};</span>
	<span class="c1">// 建立连接后使用 redisContext 来保存连接状态。
</span><span class="c1"></span>	<span class="c1">// redisContext 在每次操作后会修改其中的 err 和  errstr 字段来表示发生的错误码（大于0）和对应的描述。
</span><span class="c1"></span>	<span class="n">m_pContext</span> <span class="o">=</span> <span class="n">redisConnectWithTimeout</span><span class="p">(</span><span class="n">m_server_ip</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">m_server_port</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_pContext</span> <span class="o">||</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m_pContext</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisConnect failed: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
			<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
			<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisConnect failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="c1">// 验证
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_password</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;AUTH %s&#34;</span><span class="p">,</span> <span class="n">m_password</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span> <span class="o">||</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_ERROR</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;Authentication failure:%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">)</span>
				<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="c1">// log_info(&#34;Authentication success\n&#34;);
</span><span class="c1"></span>		<span class="p">}</span>

		<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;SELECT %d&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_STATUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="s">&#34;OK&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">)</span>
			<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;select cache db failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">DeInit</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m_pContext</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">CacheConn</span><span class="o">::</span><span class="n">GetPoolName</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">m_pool_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">string</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">string</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;GET %s&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_STRING</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">string</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">set</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">string</span> <span class="n">ret_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="c1">// 返回的结果存放在redisReply
</span><span class="c1"></span>	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;SET %s %s&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">value</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span> <span class="c1">// 释放资源
</span><span class="c1"></span>	<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">string</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">setex</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">string</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">string</span> <span class="n">ret_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;SETEX %s %d %s&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">mget</span><span class="p">(</span><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">keys</span><span class="p">,</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">ret_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keys</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">string</span> <span class="n">strKey</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">bFirst</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">keys</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">keys</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bFirst</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">bFirst</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">strKey</span> <span class="o">=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">strKey</span> <span class="o">+=</span> <span class="s">&#34; &#34;</span> <span class="o">+</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strKey</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strKey</span> <span class="o">=</span> <span class="s">&#34;MGET &#34;</span> <span class="o">+</span> <span class="n">strKey</span><span class="p">;</span>
	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="n">strKey</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_info</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_ARRAY</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">redisReply</span> <span class="o">*</span><span class="n">child_reply</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">child_reply</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_STRING</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">ret_value</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">child_reply</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">isExists</span><span class="p">(</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;EXISTS %s&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">long</span> <span class="n">ret_value</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">;</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">ret_value</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">del</span><span class="p">(</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;DEL %s&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">long</span> <span class="n">ret_value</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">;</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">hdel</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;HDEL %s %s&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">field</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">long</span> <span class="n">ret_value</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">;</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">string</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">hget</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">string</span> <span class="n">ret_value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;HGET %s %s&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">field</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_STRING</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">ret_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">hgetAll</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">ret_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;HGETALL %s&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_ARRAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">elements</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">redisReply</span> <span class="o">*</span><span class="n">field_reply</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">redisReply</span> <span class="o">*</span><span class="n">value_reply</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

			<span class="n">string</span> <span class="nf">field</span><span class="p">(</span><span class="n">field_reply</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">field_reply</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">string</span> <span class="nf">value</span><span class="p">(</span><span class="n">value_reply</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">value_reply</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">ret_value</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">make_pair</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">hset</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span> <span class="n">field</span><span class="p">,</span> <span class="n">string</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;HSET %s %s %s&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">field</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">value</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">long</span> <span class="n">ret_value</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">;</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">hincrBy</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span> <span class="n">field</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;HINCRBY %s %s %ld&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">field</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">long</span> <span class="n">ret_value</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">;</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">incrBy</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;INCRBY %s %ld&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redis Command failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">long</span> <span class="n">ret_value</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">;</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">string</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">hmset</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">hash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">string</span> <span class="n">ret_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">int</span> <span class="n">argc</span> <span class="o">=</span> <span class="n">hash</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span> <span class="o">=</span> <span class="k">new</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">[</span><span class="n">argc</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;HMSET&#34;</span><span class="p">;</span>
	<span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">hash</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">hash</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
		<span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommandArgv</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="k">delete</span><span class="p">[]</span> <span class="n">argv</span><span class="p">;</span>

		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">delete</span><span class="p">[]</span> <span class="n">argv</span><span class="p">;</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">hmget</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">fields</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">ret_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">int</span> <span class="n">argc</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span> <span class="o">=</span> <span class="k">new</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">[</span><span class="n">argc</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;HMGET&#34;</span><span class="p">;</span>
	<span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">list</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">fields</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">fields</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">c_str</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommandArgv</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">argv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="k">delete</span><span class="p">[]</span> <span class="n">argv</span><span class="p">;</span>

		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_ARRAY</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">redisReply</span> <span class="o">*</span><span class="n">value_reply</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">string</span> <span class="nf">value</span><span class="p">(</span><span class="n">value_reply</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">value_reply</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">ret_value</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">delete</span><span class="p">[]</span> <span class="n">argv</span><span class="p">;</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">incr</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;INCR %s&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redis Command failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">long</span> <span class="n">ret_value</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">;</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">decr</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;DECR %s&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redis Command failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">long</span> <span class="n">ret_value</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">;</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">lpush</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;LPUSH %s %s&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">value</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">long</span> <span class="n">ret_value</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">;</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">rpush</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">string</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;RPUSH %s %s&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">value</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">long</span> <span class="n">ret_value</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">;</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">llen</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;LLEN %s&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="kt">long</span> <span class="n">ret_value</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">;</span>
	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">lrange</span><span class="p">(</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="kt">long</span> <span class="n">end</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">ret_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;LRANGE %s %d %d&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_ARRAY</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">redisReply</span> <span class="o">*</span><span class="n">value_reply</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">element</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">string</span> <span class="nf">value</span><span class="p">(</span><span class="n">value_reply</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">value_reply</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">ret_value</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">CacheConn</span><span class="o">::</span><span class="n">flushdb</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Init</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">redisReply</span> <span class="o">*</span><span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span> <span class="o">*</span><span class="p">)</span><span class="n">redisCommand</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">,</span> <span class="s">&#34;FLUSHDB&#34;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;redisCommand failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
		<span class="n">redisFree</span><span class="p">(</span><span class="n">m_pContext</span><span class="p">);</span>
		<span class="n">m_pContext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">REDIS_REPLY_STRING</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="s">&#34;OK&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">freeReplyObject</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">///////////////
</span><span class="c1"></span><span class="n">CachePool</span><span class="o">::</span><span class="n">CachePool</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pool_name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">server_ip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">server_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">db_index</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">password</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_conn_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m_pool_name</span> <span class="o">=</span> <span class="n">pool_name</span><span class="p">;</span>
	<span class="n">m_server_ip</span> <span class="o">=</span> <span class="n">server_ip</span><span class="p">;</span>
	<span class="n">m_server_port</span> <span class="o">=</span> <span class="n">server_port</span><span class="p">;</span>
	<span class="n">m_db_index</span> <span class="o">=</span> <span class="n">db_index</span><span class="p">;</span>
	<span class="n">m_password</span> <span class="o">=</span> <span class="n">password</span><span class="p">;</span>
	<span class="n">m_max_conn_cnt</span> <span class="o">=</span> <span class="n">max_conn_cnt</span><span class="p">;</span>
	<span class="n">m_cur_conn_cnt</span> <span class="o">=</span> <span class="n">MIN_CACHE_CONN_CNT</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">CachePool</span><span class="o">::~</span><span class="n">CachePool</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">m_free_notify</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">list</span><span class="o">&lt;</span><span class="n">CacheConn</span> <span class="o">*&gt;::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">m_free_list</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">m_free_list</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">CacheConn</span> <span class="o">*</span><span class="n">pConn</span> <span class="o">=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
		<span class="k">delete</span> <span class="n">pConn</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m_free_list</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
	<span class="n">m_cur_conn_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m_free_notify</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">CachePool</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m_cur_conn_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">CacheConn</span> <span class="o">*</span><span class="n">pConn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CacheConn</span><span class="p">(</span><span class="n">m_server_ip</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">m_server_port</span><span class="p">,</span>
										 <span class="n">m_db_index</span><span class="p">,</span> <span class="n">m_password</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">m_pool_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pConn</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">())</span>
		<span class="p">{</span>
			<span class="k">delete</span> <span class="n">pConn</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">m_free_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pConn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">log_info</span><span class="p">(</span><span class="s">&#34;cache pool: %s, list size: %lu</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pool_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">m_free_list</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">CacheConn</span> <span class="o">*</span><span class="n">CachePool</span><span class="o">::</span><span class="n">GetCacheConn</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">m_free_notify</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">m_free_list</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m_cur_conn_cnt</span> <span class="o">&gt;=</span> <span class="n">m_max_conn_cnt</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">m_free_notify</span><span class="p">.</span><span class="n">Wait</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">CacheConn</span> <span class="o">*</span><span class="n">p_cache_conn</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CacheConn</span><span class="p">(</span><span class="n">m_server_ip</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">m_server_port</span><span class="p">,</span>
													<span class="n">m_db_index</span><span class="p">,</span> <span class="n">m_password</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">m_pool_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
			<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">p_cache_conn</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">log_error</span><span class="p">(</span><span class="s">&#34;Init CacheConn failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
				<span class="k">delete</span> <span class="n">p_cache_conn</span><span class="p">;</span>
				<span class="n">m_free_notify</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">m_free_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">p_cache_conn</span><span class="p">);</span>
				<span class="n">m_cur_conn_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="n">log_info</span><span class="p">(</span><span class="s">&#34;new cache connection: %s, conn_cnt: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">m_pool_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">m_cur_conn_cnt</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">CacheConn</span> <span class="o">*</span><span class="n">pConn</span> <span class="o">=</span> <span class="n">m_free_list</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
	<span class="n">m_free_list</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>

	<span class="n">m_free_notify</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">pConn</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">CachePool</span><span class="o">::</span><span class="n">RelCacheConn</span><span class="p">(</span><span class="n">CacheConn</span> <span class="o">*</span><span class="n">p_cache_conn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m_free_notify</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>

	<span class="n">list</span><span class="o">&lt;</span><span class="n">CacheConn</span> <span class="o">*&gt;::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">m_free_list</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">m_free_list</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">it</span> <span class="o">==</span> <span class="n">p_cache_conn</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">==</span> <span class="n">m_free_list</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="n">m_free_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">p_cache_conn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">m_free_notify</span><span class="p">.</span><span class="n">Signal</span><span class="p">();</span>
	<span class="n">m_free_notify</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
<span class="p">}</span>

</code></pre></div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/%E6%B1%A0%E5%BC%8F%E7%BB%93%E6%9E%84/">池式结构</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    <aside class="related-contents--wrapper">
    
    
        <h2 class="section-title">Related contents</h2>
        <div class="related-contents">
            <div class="flex article-list--tile">
                
                    
<article class="has-image">
    <a href="/p/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%BF%9B%E9%98%B6%E7%89%88/">
        
        
            <div class="article-image">
                <img src="/p/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E8%BF%9B%E9%98%B6%E7%89%88/241.67ff17709516aab444e7c867cfe2b735_hudd714e7c3305b4c239dc02d266d283b9_7211866_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy" 
                        data-key="线程池进阶版" 
                        data-hash="md5-Z/8XcJUWqrRE58hnz&#43;K3NQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">线程池进阶版</h2>
        </div>
    </a>
</article>
                
                    
<article class="has-image">
    <a href="/p/%E7%BA%BF%E7%A8%8B%E6%B1%A0/">
        
        
            <div class="article-image">
                <img src="/p/%E7%BA%BF%E7%A8%8B%E6%B1%A0/240.1d66d2f2f5cf2eed0d60df1bd2c599c2_huc6553c3d943592fc8492e4a8a4385797_5666304_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy" 
                        data-key="线程池" 
                        data-hash="md5-HWbS8vXPLu0NYN8b0sWZwg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">线程池</h2>
        </div>
    </a>
</article>
                
                    
<article class="has-image">
    <a href="/p/%E5%86%85%E5%AD%98%E6%B1%A0/">
        
        
            <div class="article-image">
                <img src="/p/%E5%86%85%E5%AD%98%E6%B1%A0/244.71de31cc6652d9902ea8c651f0059650_hud068d333fa339d76c3f1e66a3f8bf604_8126422_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy" 
                        data-key="内存池" 
                        data-hash="md5-cd4xzGZS2ZAuqMZR8AWWUA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">内存池</h2>
        </div>
    </a>
</article>
                
                    
<article class="has-image">
    <a href="/p/%E8%AF%B7%E6%B1%82%E6%B1%A0/">
        
        
            <div class="article-image">
                <img src="/p/%E8%AF%B7%E6%B1%82%E6%B1%A0/247.f5d865192346f6b27e0487d96c0700d0_hu00377075f8d3c09f9b9bff67495c3ec1_5277773_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy" 
                        data-key="请求池" 
                        data-hash="md5-9dhlGSNG9rJ&#43;BIfZbAcA0A==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">请求池</h2>
        </div>
    </a>
</article>
                
                    
<article class="has-image">
    <a href="/p/quic/">
        
        
            <div class="article-image">
                <img src="/p/quic/348.b80275718a8b9857d77e209baea32213_hu2fb516008fdf2abfd5c4a8aa9328ae4d_5294189_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy" 
                        data-key="QUIC" 
                        data-hash="md5-uAJ1cYqLmFfXfiCbrqMiEw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">QUIC</h2>
        </div>
    </a>
</article>
                
            </div>
        </div>
    
</aside>

     
     
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (DISQUS) {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2022 Gao&#39;s Happy Day
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.2.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">Table of contents</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ol>
    <li><a href="#mysql连接池">mysql连接池</a>
      <ol>
        <li><a href="#头文件">头文件：</a></li>
        <li><a href="#实现">实现：</a></li>
      </ol>
    </li>
    <li><a href="#redis连接池">redis连接池</a>
      <ol>
        <li><a href="#头文件-1">头文件</a></li>
        <li><a href="#实现-1">实现</a></li>
      </ol>
    </li>
  </ol>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
